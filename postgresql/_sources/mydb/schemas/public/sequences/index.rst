|sequences| Sequences
======================

.. |sequences| image:: /_static/images/sidebar_icons/sequences.png

-------------------------
Sequences (PostgreSQL)
-------------------------

1Ô∏è‚É£ What is a Sequence?
------------------------

A **sequence** is a **database object that generates unique numbers**, usually for IDs.

Think of it as:
    a safe, concurrent counter managed by PostgreSQL itself.

PostgreSQL guarantees that:
	- Two sessions never get the same value
	- Values are generated **without locking tables**
	- Performance stays high even under load

===============================================================================================================================

2Ô∏è‚É£ Why Sequences exist
------------------------

Without sequences, generating IDs safely would require:
	- Locks
	- Transactions
	- Race-condition handling

Sequences solve this problem **at the engine level.**

===============================================================================================================================

3Ô∏è‚É£ The classic use case: primary keys
----------------------------------------

.. code-block:: postgres 

    CREATE TABLE users (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY,
        name TEXT
    );

Behind the scenes, PostgreSQL creates:
	- a **sequence**
	- links it to users.id

You usually don‚Äôt see it, but it exists.

===============================================================================================================================

4Ô∏è‚É£ Manual sequence creation
-----------------------------

.. code-block:: postgres 

    CREATE SEQUENCE order_id_seq
        START WITH 1
        INCREMENT BY 1
        NO MINVALUE
        NO MAXVALUE
        CACHE 1;

Get the next value:

  .. code-block:: postgres 

    SELECT nextval('order_id_seq');

===============================================================================================================================

5Ô∏è‚É£ Attaching a sequence to a column
-------------------------------------

.. code-block:: postgres 

    ALTER TABLE orders
    ALTER COLUMN id SET DEFAULT nextval('order_id_seq');

Now: 

.. code-block:: postgres 

    INSERT INTO orders DEFAULT VALUES;

‚Üí ID is auto-generated.

===============================================================================================================================

6Ô∏è‚É£ nextval, currval, setval (important!)

nextval()

.. code-block:: postgres 

    SELECT nextval('order_id_seq');

‚úî Advances sequence

‚úî Returns a new value

===============================================================================================================================

currval()

.. code-block:: postgres 

    SELECT currval('order_id_seq');

‚úî Returns **last value used in this session**

‚ùå Errors if nextval() was never called

===============================================================================================================================

setval()

.. code-block:: postgres 

    SELECT setval('order_id_seq', 1000);

‚úî Manually resets the sequence

Very useful after bulk imports.

===============================================================================================================================

7Ô∏è‚É£ Sequences are NOT transactional

This is critical:

.. code-block:: postgres 

    BEGIN;
    SELECT nextval('order_id_seq');
    ROLLBACK;

The number is **lost forever**

This is **by design** to ensure performance and concurrency.

===============================================================================================================================

8Ô∏è‚É£ Sequences vs SERIAL vs IDENTITY
------------------------------------

Old style (SERIAL)

.. code-block:: postgres 

    id SERIAL

Problems:
	- Hidden sequence
	- Harder to control
	- Not SQL-standard

===============================================================================================================================

**Modern style (IDENTITY)** 

.. code-block:: postgres 

    id BIGINT GENERATED ALWAYS AS IDENTITY

Advantages:
	- SQL standard
	- Explicit ownership
	- Safer schema migrations

Recommendation:
    Use **IDENTITY**, not SERIAL.

===============================================================================================================================

9Ô∏è‚É£ Sequence ownership
-----------------------

Sequences should be **owned by a column:**

.. code-block:: postgres 

    ALTER SEQUENCE order_id_seq
    OWNED BY orders.id;

Why this matters:
	- Dropping table drops sequence
	- Cleaner schema
	- Fewer orphan objects

===============================================================================================================================

üîü Permissions & security
---------------------------

You can restrict sequence usage:

.. code-block:: postgres 

    REVOKE ALL ON SEQUENCE order_id_seq FROM PUBLIC;
    GRANT USAGE, SELECT ON SEQUENCE order_id_seq TO app_role;

In production:
	- Applications usually **don‚Äôt call sequences directly**
	- They rely on DEFAULT values

===============================================================================================================================

1Ô∏è‚É£1Ô∏è‚É£ Performance tuning (advanced)
--------------------------------------

CACHE

.. code-block:: postgres 

    CACHE 100

- Improves performance
- May skip numbers on crash
- Usually safe

NO CYCLE (default)

.. code-block:: postgres 

    NO CYCLE

- Prevents reuse of IDs
- Almost always what you want

===============================================================================================================================

1Ô∏è‚É£2Ô∏è‚É£ When NOT to use sequences
-----------------------------------

Avoid sequences if:
	- IDs must be gapless (accounting numbers)
	- Ordering must reflect commit order
	- IDs must be meaningful

Use:
	- Explicit locking
	- Custom logic
	- Separate numbering tables

===============================================================================================================================

1Ô∏è‚É£3Ô∏è‚É£ Sequences vs UUIDs
-------------------------

.. list-table:: 
    :header-rows: 1

    * - Feature
      - Sequence
      - UUID
    * - Readability
      - ‚úÖ
      - ‚ùå
    * - Index size
      - Small
      - Large
    * - Ordering
      - Natural
      - Random
    * - Distributed-safe
      - ‚ùå
      - ‚úÖ
    * - Performance
      - Fast
      - Slower

Many systems use:
	- Sequence for internal PK
	- UUID for public/external IDs

===============================================================================================================================

Summary
    A sequence is a high-performance, concurrency-safe number generator used primarily for primary keys in PostgreSQL.














